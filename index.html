<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes">
  <title>Snow Rider 3d</title>

  <!-- Favicon + Styles used by your loader UI -->
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">

  <!-- UNITY_BUILD from your current index.html so hashed paths are available to both modes -->
  <script>
    window.UNITY_BUILD = {
      companyName: "Snow Rider 3d",
      productName: "Snow Rider 3d",
      productVersion: "2.8",
      buildUrl: "Build",
      loaderUrl: "Build/snowrider3d_gd_3_3.loader.js",
      dataUrl: "Build/snowrider3d_gd_3_3.data.unityweb",
      frameworkUrl: "Build/snowrider3d_gd_3_3.framework.js.unityweb",
      codeUrl: "Build/snowrider3d_gd_3_3.wasm.unityweb",
    };
  </script>

  <!-- Your working orientation engine (used on MOBILE only) -->
  <script src="webglScreen.js"></script>
<!-- Mobile-only audio mute/unmute helper (safe no-op on desktop) -->
    <script>
    (function () {
      // match your existing UA test
      var isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent)
                     || (window.matchMedia && matchMedia("(pointer:coarse)").matches);

      function hookMobileAudio(gi) {
        if (!isMobile) return; // ⬅️ only on mobile
        /*
        var muted = false, t = 0;
        function debounced(fn){ clearTimeout(t); t = setTimeout(fn, 60); }

        function setMuted(flag){
          if (flag === muted) return;
          muted = flag;
          // Prefer SetMuted (mute via volume); fall back to SetPaused if present
          try { gi.SendMessage && gi.SendMessage("AudioBridge","SetMuted", flag ? 1 : 0); } catch(e){}
          try { gi.SendMessage && gi.SendMessage("AudioBridge","SetPaused", flag ? 1 : 0); } catch(e){}
        }

        function onHide(){ debounced(function(){ setMuted(true);  }); }
        function onShow(){ debounced(function(){ setMuted(false); }); }

        document.addEventListener("visibilitychange", function(){
          if (document.hidden) onHide(); else onShow();
        }, { passive:true });

        window.addEventListener("pagehide",  onHide, { passive:true });
        window.addEventListener("blur",      onHide, { passive:true });
        window.addEventListener("pageshow",  onShow, { passive:true });
        window.addEventListener("focus",     onShow, { passive:true });
        */
      }

      // expose for callers
      window.__hookMobileAudio = hookMobileAudio;
    })();
    </script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#000; }
    /* Containers: only one is visible at a time */
    #mobile-wrap, #desktop-wrap { position:fixed; inset:0; }
    #mobile-wrap { display:none; }   /* shown on mobile */
    #desktop-wrap { display:none; }  /* shown on desktop */

    /* Desktop canvas container uses same IDs/classes as your game.html */
    #unity-container { position: fixed; inset: 0; }
    #unity-canvas { display:block; outline:none; background:#000; }

    /* (Optional) harden overlay z-index to stay above canvas during load */
    #unity-loading-bar { z-index: 9999; }
  </style>
</head>
<body>
  <!-- MOBILE MODE (uses your exact iframe + RotScreen flow) -->
  <div id="mobile-wrap">
    <iframe id="Frame"
            src="about:blank"
            allow="autoplay; fullscreen; gamepad; xr-spatial-tracking"
            style="border:0; position:fixed; inset:0; width:100%; height:100%;"></iframe>
  </div>

  <!-- DESKTOP MODE (runs Unity directly on this page, no iframe) -->
  <div id="desktop-wrap">
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>

      <div id="unity-loading-bar">
        <div id="unity-logo">
          <div id="unity-text-progress"></div>
        </div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>

      <div id="unity-warning"></div>
    </div>
  </div>

  <script>
    // ---------- Device detection ----------
    const isMobileUA = /iPhone|iPad|iPod|Android|IEMobile|Windows Phone|BlackBerry|Opera Mini/i.test(navigator.userAgent);
    const prefersMobileLayout = isMobileUA || (('ontouchstart' in window) && Math.max(window.innerWidth, window.innerHeight) <= 1024);

    const mobileWrap  = document.getElementById('mobile-wrap');
    const desktopWrap = document.getElementById('desktop-wrap');

    if (prefersMobileLayout) {
      // ===== MOBILE: show iframe and rotate the container with your RotScreen() =====
      mobileWrap.style.display = 'block';
      const iframe = document.getElementById('Frame');
      iframe.src = 'game.html';

      // Hook your rotation helper exactly like your working page
      window.gameframe = iframe;                           // rotate this element (not the canvas)
      window.WebglOrientation = WebglScreenOrientation.AutoRotation;
      try { RotScreen(); } catch(e) { console.warn(e); }

      // Keep in sync with viewport changes
      function updateVH() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', vh + 'px');
      }
      updateVH();
      window.addEventListener('resize', function(){ updateVH(); try{ RotScreen(); }catch(_){ } }, false);
      window.addEventListener('orientationchange', function(){ try{ RotScreen(); }catch(_){ } }, false);

      // Optional: Load orientation config (same as your index.html)
      try {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            window.WebglOrientation = data.ScreenOrientation;
            try { RotScreen(); } catch(_){}
          }
        };
        xhr.open("GET", "StreamingAssets/webglscreenSetting/ScreenConfig.json", true);
        xhr.send();
      } catch(e){}
    } else {
      // ===== DESKTOP: run Unity directly on this page (no iframe) =====
      desktopWrap.style.display = 'block';

      // Pull UB from this page (no parent iframe)
      var UB = window.UNITY_BUILD;
      if (!UB) { alert("UNITY_BUILD not found"); }

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var textProgress = document.querySelector("#unity-text-progress");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var progressBarEmpty = document.querySelector("#unity-progress-bar-empty");
      var warningBanner = document.querySelector("#unity-warning");

      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type === 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type === 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function () {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      if (UB && UB.productName) document.title = UB.productName;

      // Desktop sizing (full window)
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      window.addEventListener('resize', function(){
        // minor debounce so Unity doesn't thrash
        setTimeout(function(){
          canvas.style.width = window.innerWidth + 'px';
          canvas.style.height = window.innerHeight + 'px';
        }, 250);
      }, false);

      // Build config from UB (only include optional fields if present to avoid #if macros)
      var config = {
        dataUrl: UB.dataUrl,
        frameworkUrl: UB.frameworkUrl,
        streamingAssetsUrl: "StreamingAssets",
        companyName: UB.companyName,
        productName: UB.productName,
        productVersion: UB.productVersion,
        showBanner: unityShowBanner
      };
      if (UB.codeUrl)    config.codeUrl = UB.codeUrl;
      if (UB.memoryUrl)  config.memoryUrl = UB.memoryUrl;
      if (UB.symbolsUrl) config.symbolsUrl = UB.symbolsUrl;

      loadingBar.style.display = "block";
      var showLoadingBar = false;
      if (!showLoadingBar) progressBarEmpty.style.display = "none";

      const rootPath = 'TemplateData';
      var script = document.createElement("script");
      script.src = UB.loaderUrl;              // unhashed loader provided by UNITY_BUILD
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
        if (progress >= 0.9 && progress < 1) {
            textProgress.innerHTML =
              'Opening ' + UB.productName +
              '<img src="' + rootPath + '/gears.gif" class="spinner" width="90" height="90" />';
            progressBarEmpty.style.display = "none";
          } else {
            textProgress.innerHTML =
              'Loading ' + UB.productName + ' - ' + Math.floor(progress * 100)  + '%' +
              '<img src="' + rootPath + '/gears.gif" class="spinner" width="90" height="90" />';
          }
          if (showLoadingBar) {
            progressBarFull.style.width = (progress * 100) + "%";
          }
        }).then((unityInstance) => {
          loadingBar.style.display = "none";
            // call is harmless on desktop (helper early-returns)
              if (window.__hookMobileAudio) { window.__hookMobileAudio(unityInstance); }
        }).catch((message) => {
          alert(message);
        });
      };
      document.body.appendChild(script);
    }
  </script>
   <!-- Mobile-only keep-awake (inline, no external file) -->
<script>
(function(){
  var isMobile = /Android|iPhone|iPad|iPod|IEMobile|Windows Phone|BlackBerry|Opera Mini/i.test(navigator.userAgent);
  if (!isMobile) return;

  (function(global){
    var sentinel = null;
    var active = false;

    async function requestWakeLock(){
      if ('wakeLock' in navigator && navigator.wakeLock && typeof navigator.wakeLock.request === 'function'){
        try{
          sentinel = await navigator.wakeLock.request('screen');
          active = true;
          if (sentinel && typeof sentinel.addEventListener === 'function'){
            sentinel.addEventListener('release', function(){
              if (document.visibilityState === 'visible'){
                requestWakeLock().catch(function(){});
              }
            });
          }
          return true;
        }catch(e){}
      }
      return false;
    }

    function onGesture(){
      document.removeEventListener('pointerdown', onGesture, true);
      document.removeEventListener('touchend', onGesture, true);
      requestWakeLock().catch(function(){});
    }

    document.addEventListener('pointerdown', onGesture, true);
    document.addEventListener('touchend', onGesture, true);

    document.addEventListener('visibilitychange', function(){
      if (document.visibilityState === 'visible' && active && sentinel == null){
        requestWakeLock().catch(function(){});
      }
    }, false);
  })(window);
})();
</script>
</body>
</html>
